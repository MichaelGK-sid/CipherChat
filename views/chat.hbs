<div class="chat-container">
  <div class="chat-header">
    <div class="chat-contact-info">
      <div class="contact-avatar"></div>
      <span class="chat-contact-name">{{username}}</span>
    </div>
    <a href="/home" class="home-link">Home</a>
  </div>

  <div class="chat-messages" id="messages">
    {{#each messages}}
    <div class="message {{#if this.isMine}}message-mine{{else}}message-theirs{{/if}}">
      <div class="message-bubble">
        {{this.text}}
      </div>
    </div>
    {{/each}}
  </div>

  <div class="chat-input-container">
    <form id="chat-form" class="chat-form">
      <input type="text" id="message-input" placeholder="Type a message..." class="chat-input" required />
      <button type="submit" class="send-button">Send</button>
    </form>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const currentUserId = '{{currentUserId}}';
    const recipientId = '{{recipientId}}';
    
    console.log('Current User:', currentUserId);
    console.log('Recipient:', recipientId);
    
    // Register this user with their socket
    socket.emit('register_user', currentUserId);
    
    // Listen for incoming messages
    socket.on('receive_message', (data) => {
      console.log('Received message:', data);
      if (data.senderId === recipientId) {
        addMessageToChat(data.ciphertext, false);
      }
    });
    
    // Listen for message sent confirmation
    socket.on('message_sent', (data) => {
      console.log('Message sent successfully:', data);
    });
    
    // Handle form submit
    const chatForm = document.getElementById('chat-form');
    if (chatForm) {
      chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
      });
    }
    
    // Send message function
    function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      
      if (message) {
        console.log('Sending message:', message);
        
        socket.emit('send_message', {
          senderId: currentUserId,
          recipientId: recipientId,
          ciphertext: message,
          iv: 'dummy-iv-' + Date.now()
        });
        
        addMessageToChat(message, true);
        input.value = '';
      }
    }
    
    function addMessageToChat(text, isMine) {
      const messagesContainer = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ' + (isMine ? 'message-mine' : 'message-theirs');
      
      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'message-bubble';
      bubbleDiv.textContent = text;
      
      messageDiv.appendChild(bubbleDiv);
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  });
</script>